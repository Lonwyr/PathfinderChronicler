sap.ui.define(["./BaseController","sap/ui/core/Fragment","sap/ui/core/ListItem","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,n,a,i){"use strict";function r(e,t){return e.find(e=>e.id===t)}function s(e,t,n){const a=e.widthOfTextAtSize(n.text,n.size);t.drawText(n.text,{size:n.size,x:n.x-a/2,y:n.y})}function o(e,t,n){const a=e.widthOfTextAtSize(n.text,n.size);t.drawText(n.text,{size:n.size,x:n.x-a,y:n.y})}function d(e,t,n,a,i){const r=666;if(n){s(e,t,{text:a==="player"?n.name:n.name+"(GM)",size:10,x:95,y:r});o(e,t,{text:n.id,size:12,x:341.5,y:r})}if(i){s(e,t,{text:i.name,size:10,x:220,y:r});t.drawText(i.id.substring(1),{size:12,x:363,y:r})}}function c(e){}function l(e,t,n,a,i,r,o){const d=525;if(n){s(e,t,{text:n.toString(),size:12,x:d,y:460})}if(i&&r){const n=a[i-1]*r;s(e,t,{text:n.toString(),size:12,x:d,y:350})}if(o){s(e,t,{text:o.toString(),size:12,x:d,y:130})}}function g(e,t,n,a,i){const r=55;if(n){s(e,t,{text:n.name,size:10,x:100,y:r});s(e,t,{text:n.id,size:12,x:190,y:r})}if(a){s(e,t,{text:a,size:12,x:270,y:r})}if(i){s(e,t,{text:i.id,size:12,x:520,y:r})}}async function p(e,t,n,a,i,s,o,p,y){const f=await e.load(t,{ignoreEncryption:true});const u=await f.embedFont(n.Helvetica);const h=f.getPages();const m=h[0];const x=r(a.players,i.playerId);const P=x&&r(x.characters,i.characterId);d(u,m,x,i.type,P);c(u,m);l(u,m,s.xp,o.bundleValues,P&&P.level,s.treasureBundles,s.fame);g(u,m,p,s.date,y);const I=await f.save();download(I,"pdf-lib_modification_example.pdf","application/pdf")}return e.extend("com.lonwyr.PathfinderChronicler.controller.CreateSheets",{formatPlayerTitle:(e,t)=>r(t,e.playerId).name,formatPlayerId:function(e,t){return r(t,e.playerId).id},formatCharacterButtonText:function(e,t){if(!e.characterId){return this.getResourceBundle().getText("noCharacterSelected")}const n=r(t,e.playerId);const a=r(n.characters,e.characterId);return a.name+" ("+a.id+")"},addPlayerToSession:function(){if(!this.byId("addPlayer")){const e=this.getView();t.load({id:e.getId(),name:"com.lonwyr.PathfinderChronicler.fragments.AddPlayerToSession",controller:this}).then(t=>{e.addDependent(t);t.open()})}else{this.byId("addPlayer").getBinding("items").filter([]);this.byId("addPlayer").open()}},formatAddPlayerVisibility:function(e,t){return t.every(t=>t.playerId!==e)},search:function(e){const t=e.getParameter("value");const n=new a("name",i.Contains,t);const r=new a("id",i.Contains,t);const s=new a({filters:[n,r],and:false});const o=e.getParameter("itemsBinding");o.filter([s])},addPlayer:function(e){const t=e.getParameter("selectedItem").getBindingContext("data");const n=t.getPath();const a=t.getModel().getProperty(n).id;let i=this.getModel("printOptions").getProperty("/players");i.push({playerId:a,characterId:undefined,type:"player"});this.getModel("printOptions").setProperty("/players",i)},deleteCharacterFromSession:function(e){const t=e.getSource();const n=e.getParameter("listItem");const a=n.getBindingContext("printOptions").getPath();const i=Number.parseInt(a.substring("/players/".length));t.attachEventOnce("updateFinished",t.focus,t);let r=this.getModel("printOptions");let s=r.getProperty("/players");s.splice(i,1);r.setProperty("/players",s)},changeCharacter:async function(e){const n=e.getSource().getBindingContext("printOptions");const a=n.getPath();const i=n.getModel().getProperty(a).playerId;const r=this.getModel("data");const s=r.getProperty("/players").findIndex(e=>e.id===i);const o=r.createBindingContext("/players/"+s);let d=this.byId("selectCharacter");if(!d){const e=this.getView();d=await t.load({id:e.getId(),name:"com.lonwyr.PathfinderChronicler.fragments.SelectCharacterForSession",controller:this});e.addDependent(d)}d.getBinding("items").filter([]);d.setBindingContext(o,"data");d.getCustomData()[0].setValue(a);d.open()},selectCharacter:function(e){const t=e.getParameter("selectedItem").getBindingContext("data");const n=t.getPath();const a=t.getModel().getProperty(n).id;const i=e.getSource().getCustomData()[0].getValue();this.getModel("printOptions").setProperty(i+"/characterId",a);this.getModel("printOptions").updateBindings(true)},createSheets:function(e){var t=e.getParameter("files")&&e.getParameter("files")[0];const n=this.getModel("printOptions").getData();const a=this.getModel("data").getData();const i=this.getModel("treasures").getData();const{degrees:s,PDFDocument:o,rgb:d,StandardFonts:c}=PDFLib;const l=n.players.find(e=>e.type==="gm");const g=l&&r(a.players,l.playerId);const y=this.byId("eventSelect").getSelectedKey();const f=r(a.events,y);if(t&&window.FileReader){var u=new FileReader;u.onload=async function(e){var t=e.target.result;n.players.map(async e=>{p(o,t,c,a,e,n,i,f,g)});if(n.additionalSheet){p(o,t,c,a,{type:"player"},n,i,f,g)}};u.readAsArrayBuffer(t)}}})});